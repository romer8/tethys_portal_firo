name: Build and Push Singularity Image

on:
  push:
    branches:
      - singularity
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'false'

      - name: Update submodules recursively
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Singularity setup
        uses: singularityhub/install-singularity@main

      - name: Import and Verify Singularity key
        env:
          KEY_B64: ${{ secrets.SIGNING_KEY }}
          KEY_PASS: ${{ secrets.KEY_PASSPHRASE }}
        run: |
          # Decode key and verify format
          echo "$KEY_B64" | base64 -d > private.asc
          echo "=== Key File Header ==="
          head -n 1 private.asc  # Should show "-----BEGIN PGP PRIVATE KEY BLOCK-----"
          
          # Import key with passphrase validation
          echo "=== Key Import ==="
          echo "$KEY_PASS" | singularity key import private.asc 2>&1 | tee import.log
          
          # Verify successful import
          echo "=== Imported Keys ==="
          singularity key list
          
      - name: Build Singularity Image
        run: |
            sudo -E singularity build singularity-firo-tethys-portal.sif firo_portal.def


      - name: Sign the image
        run: |
           echo "${{ secrets.KEY_PASSPHRASE }}" | singularity sign --keyidx 0 singularity-firo-tethys-portal.sif

      - name: Configure ORAS Remote
        run: |
          # Add a new remote named 'ghcr' pointing to oras://ghcr.io
          singularity remote add --no-login ghcr oras://ghcr.io

      - name: Login and Push to GitHub Registry
        env:
          IMAGE_NAME: romer8/tethys_portal_firo
          GHCR_USERNAME: ${{ github.actor }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        run: |
          # Login to the 'ghcr' remote with your *personal access token*, not the built-in GITHUB_TOKEN
          echo "${GHCR_PAT}" | singularity remote login -u "${GHCR_USERNAME}" --password-stdin ghcr
      
          # Push to ghcr.io
          singularity push singularity-firo-tethys-portal.sif \
            oras://ghcr.io/${IMAGE_NAME}:latest_x86
